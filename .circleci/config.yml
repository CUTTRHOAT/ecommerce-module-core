version: 2.1

commands:
  build:
    steps:
      - checkout
      - run:
          name: Java
          command: |
              echo oracle-java8-installer shared/accepted-oracle-license-v1-1 select true | debconf-set-selections && \
              add-apt-repository -y ppa:webupd8team/java && \
              apt-get update && \
              apt-get install -y oracle-java8-installer --allow-unauthenticated && \
              rm -rf /var/lib/apt/lists
      - run:
          name: Install system packages
          command: apt-get update && apt-get -y install zip git zlib1g-dev wget
      - run:
          name: Install PHP extensions
          command: |               
            docker-php-ext-install pdo
            docker-php-ext-install zip
      - run:
          name: Display PHP information
          command: |
            php -v
            java --version
      - run:
          name: Check PHP sintax
          command: find . -name \*.php -exec php -l "{}" \;
      - run:
          name: Download composer
          command: |
            php -r "copy('http://getcomposer.org/installer', 'composer-setup.php');"
            php composer-setup.php
      - run:
          name: Mock hook-git
          command: mkdir -p .git/hooks
      - run:
          name: Install dependecy-composer
          command: php composer.phar install
      - run:
          name: Run PHPUnit
          command: vendor/bin/phpunit
      - persist_to_workspace:
          root: /
          paths:
            - app
  build_test:
    steps:
      - run:
          name: Code coverage
          command: | 
            mkdir -p build/logs            
            apt-get install libcurl4-gnutls-dev
            docker-php-ext-install curl
            pecl install xdebug
            docker-php-ext-enable xdebug
            php vendor/bin/phpunit --coverage-clover build/coverage/xml   
            curl -L https://github.com/codacy/codacy-coverage-reporter/releases/download/4.0.5/codacy-coverage-reporter-4.0.5-assembly.jar > ./codacy-test-reporter.jar
            chmod +x ./codacy-test-reporter.jar
            java -jar ./codacy-test-reporter.jar report --language PHP -t ${CODACY_PROJECT_TOKEN} -r build/coverage/xml
          
            
      - store_artifacts:
          path:  build/coverage-report       
jobs:
  build-php56:
    working_directory: /app
    docker:
      - image: php:5.6-apache
        environment:
          APP_ENV: test
    steps:
      - build

  build-php72:
    working_directory: /app
    docker:
      - image: php:7.2-apache
      - image: openjdk:8  
        environment:
          APP_ENV: test      
    steps:
      - build
      - build_test

workflows:
  build_publish_deploy:
    jobs:
      - build-php56
      - build-php72

